ARCH_LIBDIR ?= /lib/$(shell $(CC) -dumpmachine)

ifeq ($(DEBUG),1)
GRAMINE_LOG_LEVEL = debug
CFLAGS += -O0 -ggdb3
else
GRAMINE_LOG_LEVEL = error
CFLAGS += -O2
endif

CFLAGS += -fPIE
LDFLAGS += -pie

RA_TYPE ?= none
RA_CLIENT_SPID ?=
RA_CLIENT_LINKABLE ?= 0

.PHONY: clients
clients: secret_prov/client 
### clients: secret_prov_minimal/client secret_prov/client secret_prov_pf/client

.PHONY: all
all: app epid  # by default, only build EPID because it doesn't rely on additional (DCAP) libs

.PHONY: app
app: \
     tls_secret_prov/server.crt \
     secret_prov/client.manifest.sgx  secret_prov/client.sig     secret_prov/client.token

.PHONY: epid
epid: tls_secret_prov/server.crt secret_prov/server_epid

.PHONY: dcap
dcap: tls_secret_prov/server.crt secret_prov_minimal/server_dcap secret_prov/server_dcap secret_prov_pf/server_dcap \
      secret_prov_pf/wrap_key secret_prov_pf/enc_files/input.txt

############################# SSL DATA DEPENDENCY #############################

# SSL data: key and x.509 self-signed certificate
tls_secret_prov/server.crt: tls_secret_prov/ca_config.conf
	openssl genrsa -out tls_secret_prov/ca.key 2048
	openssl req -x509 -new -nodes -key tls_secret_prov/ca.key -sha256 -days 1024 -out tls_secret_prov/ca.crt -config tls_secret_prov/ca_config.conf
	openssl genrsa -out tls_secret_prov/server.key 2048
	openssl req -new -key tls_secret_prov/server.key -out tls_secret_prov/server.csr -config tls_secret_prov/ca_config.conf
	openssl x509 -req -days 360 -in tls_secret_prov/server.csr -CA tls_secret_prov/ca.crt -CAkey tls_secret_prov/ca.key -CAcreateserial -out tls_secret_prov/server.crt

######################### CLIENT/SERVER EXECUTABLES ###########################

# Use hard-coded GRAMINEDIR because we currently fail to provide secret prov headers in Gramine
# installation. We also use `sgx_util` pkg-config because we don't have a secret prov one.
# TODO: Create a pkg-config file for secretprov_gramine libs, and use it in below
#       CFLAGS/LDFLAGS lines (via `pkg-config {--cflags|--libs} secretprov_gramine`).
GRAMINEDIR ?= ../..
CFLAGS += -Wall -std=c11 -I$(GRAMINEDIR)/tools/sgx/ra-tls
LDFLAGS += -Wl,--enable-new-dtags $(shell pkg-config --libs sgx_util)

%/server_epid: %/server.c
	$(CC) $< $(CFLAGS) $(LDFLAGS) -lsecret_prov_verify_epid -pthread -o $@

# linker option --no-as-needed is required because SGX DCAP library (libsgx_dcap_quoteverify.so)
# does dlopen() instead of directly linking against libsgx_urts.so, and without this option
# compilers remove the "seemingly unused" libsgx_urts.so
%/server_dcap: %/server.c
	$(CC) $< $(CFLAGS) $(LDFLAGS) -Wl,--no-as-needed -lsgx_urts -lsecret_prov_verify_dcap -pthread -o $@

secret_prov/client: secret_prov/client.c
	$(CC) $< $(CFLAGS) $(LDFLAGS) -lsecret_prov_attest -o $@

### secret_prov_minimal/client: secret_prov_minimal/client.c
###	$(CC) $< $(CFLAGS) $(LDFLAGS) -o $@

### secret_prov_pf/client: secret_prov_pf/client.c
###	$(CC) $< $(CFLAGS) $(LDFLAGS) -o $@

############################### CLIENT MANIFEST ###############################

secret_prov/client.manifest: secret_prov/client.manifest.template
	cd secret_prov && \
	gramine-manifest \
		-Dlog_level=$(GRAMINE_LOG_LEVEL) \
		-Darch_libdir=$(ARCH_LIBDIR) \
		-Dra_type=$(RA_TYPE) \
		-Dra_client_spid=$(RA_CLIENT_SPID) \
		-Dra_client_linkable=$(RA_CLIENT_LINKABLE) \
		$(notdir $<) > $(notdir $@)

secret_prov/client.manifest.sgx secret_prov/client.sig: sgx_sign_secret_prov_client
	@:

.INTERMEDIATE: sgx_sign_secret_prov_client
sgx_sign_secret_prov_client: secret_prov/client.manifest secret_prov/client
	cd secret_prov && \
	gramine-sgx-sign \
		--manifest $(notdir $<) \
		--output $(notdir $<.sgx)

secret_prov/client.token: secret_prov/client.sig
	gramine-sgx-get-token --output $@ --sig $<

############################# SGX CHECKS FOR CI ###############################

# Note: `wait_for_server` unfortunately causes the server to emit the following error:
#     client_connection: Secret Provisioning failed during mbedtls_ssl_handshake with error -29312
# It just means that there was an EOF before finishing SSL handshake, which is expected in this
# case.

.PHONY: check_epid
check_epid: app epid
	# secret_prov
	cd secret_prov; \
	./server_epid >/dev/null & SERVER_ID=$$!; \
	../../../scripts/wait_for_server 60 127.0.0.1 4433; \
	gramine-sgx client > ../OUTPUT; \
	kill -9 $$SERVER_ID;
	@grep -E "Received secret1 = 'FIRST_SECRET', secret2 = '42'" OUTPUT && echo "[ Success 2/4 ]"
	@rm OUTPUT

.PHONY: check_dcap
check_dcap: app dcap
	# secret_prov
	cd secret_prov; \
	./server_dcap >/dev/null & SERVER_ID=$$!; \
	../../../scripts/wait_for_server 60 127.0.0.1 4433; \
	gramine-sgx client > ../OUTPUT; \
	kill -9 $$SERVER_ID;
	@grep -E "Received secret1 = 'FIRST_SECRET', secret2 = '42'" OUTPUT && echo "[ Success 2/4 ]"

###
	@rm OUTPUT

################################## CLEANUP ####################################

.PHONY: clean
clean:
	$(RM) OUTPUT
###	cd secret_prov_minimal; $(RM) client server_* *.token *.sig *.manifest.sgx *.manifest
	cd secret_prov;         $(RM) client server_* *.token *.sig *.manifest.sgx *.manifest
###	cd secret_prov_pf;      $(RM) client server_* *.token *.sig *.manifest.sgx *.manifest

.PHONY: distclean
distclean: clean
###	$(RM) -r secret_prov_pf/wrap_key secret_prov_pf/enc_files/input.txt tls_secret_prov/ca.* tls_secret_prov/server.*
